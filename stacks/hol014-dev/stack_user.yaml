description: >-
  HOL014, classroom for MicroShift and other Red Hat Device Edge Quick Courses
  based on BFX000-RHEL9.2 (dev), generated by dle-doit (version 0.2.5.dev1+gdcb0fb4).
# This is a development blueprint, hacked from HOL010 on RHEL 9.2 with custom images created by 'dnf update' workstation and servera to RHEL 9.4
heat_template_version: '2018-03-02'
parameters:
  web_token:
    type: string
    default: a982ef31-f55f-4694-9836-fde1a40eb9b5
    description: Token for the webapp console
  builder_network_id:
    type: string
    description: builder_network
    default: builder_network
  public_net_id:
    default: provider-network
    description: The network that provides external access.
    type: string
  private_net_id:
    default: external-egress-classroom
    description: The network that provides external access.
    type: string
  az:
    type: string
    description: availability zone
    default: GLS
  enable_screenreader:
    default: false
    type: boolean
  enable_ssh:
    default: true
    type: boolean
  ssh_server:
    default: classroom
    type: string
  ssh_public_port:
    default: 22022
    type: number
  ssh_bastion_port:
    default: 53009
    type: number
conditions:
  validate_ssh:
    equals:
      - get_param: enable_ssh
      - true
  validate_screenreader:
    equals:
      - get_param: enable_screenreader
      - true
outputs:
  public_ip0:
    description: The external (public) IP address for classroom
    value: { get_attr: [ if: [validate_ssh, classroom_server, null],   networks, provider-network, 0] }
    condition: validate_ssh
  ssh_classroom_command1:
    description: SSH to the external (public) IP address for classroom
    value:
      list_join: ['', ['ssh -i ~/.ssh/instructor_key -p 22022 instructor@', { get_attr: [classroom_server, networks, provider-network, 0] }]]
  ssh_classroom_command2:
    description: SSH to the external (public) IP address for classroom
    value:
      list_join: ['', ['ssh -i ~/.ssh/ptlab_key -p 22022 instructor@', { get_attr: [classroom_server, networks, provider-network, 0] }]]
  ssh_workstation_from_classroom_command:
    description: SSH from classroom to workstation
    value:
      list_join: ['', ['ssh student@', { get_attr: [workstation_server, networks, student_network, 0] }]] 
  ssh_classroom_command:
    description: SSH to the external (public) IP address for classroom
    value:
      list_join: ['', ['ssh -i ~/.ssh/rht_classroom.rsa -J instrutor@', { get_attr: [classroom_server, networks, provider-network, 0] }, ':22022 student@172.25.252.1 -p 53009']]
resources:
  disable_screenreader_config:
    type: OS::Heat::SoftwareConfig
    properties:
      group: ungrouped
      config: |
        #!/bin/bash
          sed -i -e '/^PasswordAuthentication/s/no/yes/' /etc/ssh/sshd_config
          sed -i -e '/^ssh_pwauth:/s/0/1/' /etc/cloud/cloud.cfg
          echo $(sed -e 's/.*release //' -e 's/ .*//' /etc/redhat-release) > /tmp/rht-release
          mv /usr/libexec/gsd-subman /usr/libexec/gsd-subman-NO
          dnf remove -y gnome-tour
          sed -i -e '/^screen-reader-enabled=/s/true/false/' /etc/dconf/db/local.d/02-screenreader
          dconf update
  enable_screenreader_config:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        runcmd:
          - sed -i -e '/^PasswordAuthentication/s/no/yes/' /etc/ssh/sshd_config
          - sed -i -e '/^ssh_pwauth:/s/0/1/' /etc/cloud/cloud.cfg
          - echo $(sed -e 's/.*release //' -e 's/ .*//' /etc/redhat-release) > /tmp/rht-release
          - mv /usr/libexec/gsd-subman /usr/libexec/gsd-subman-NO
          - dnf remove -y gnome-tour
  enable_config:
    type: OS::Heat::MultipartMime
    properties:
      parts:
      - config: {get_resource: enable_screenreader_config}
  disable_config:
    type: OS::Heat::MultipartMime
    properties:
      parts:
      - config: {get_resource: disable_screenreader_config}

  # Development Hacks for RHDE-3 (rhde-microshift)
  # TODO: Add the RHDE ISO with MicroShift repos, containers, etc
  # TODO: Configure the registry CNAME to point to servera

  # As I'm building custom VM images for workstation, servera, and serverb anyway, why not having those customizations just baked into the image?
  # I don't really need to do most of that using cloud-init, I only need it on VMs such as classrooms that I'm not creating new images
  rhel94_repos_config:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        # VMs from HOL010 were subscribed and using internet repos, despoite having the RHEL 9.2 DVD
        runcmd:
          - touch /root/rhel94_repos_config_runcmd
          - rm /etc/yum.repos.d/rhel_dvd.repo
          - yum clean all
          - subscription-manager unregister
        yum_repos:
          rhel-9.4-for-x86_64-baseos-rpms:
            baseurl: http://content.example.com/rhel9.4/x86_64/dvd/BaseOS
            enabled: true
            gpgcheck: true
            gpgkey: http://content.example.com/rhel9.4/x86_64/dvd/RPM-GPG-KEY-redhat-release
            name: Red Hat Enterprise Linux 9.4 BaseOS (dvd)
          rhel-9.4-for-x86_64-appstream-rpms:
            baseurl: http://content.example.com/rhel9.4/x86_64/dvd/AppStream
            enabled: true
            gpgcheck: true
            gpgkey: http://content.example.com/rhel9.4/x86_64/dvd/RPM-GPG-KEY-redhat-release
            name: Red Hat Enterprise Linux 9.4 AppStream (dvd)

  # microshift_repos_config:
  #   type: OS::Heat::CloudConfig
  #   properties:
  #     cloud_config:
  #       yum_repos:
  #         rhocp-4.17-for-rhel-9-x86_64-rpms:
  #           baseurl: http://content.example.com/rhde/rpms/rhocp-4.17-for-rhel-9-x86_64-rpms
  #           enabled: true
  #           gpgcheck: true
  #           gpgkey: http://content.example.com/rhel9.4/x86_64/dvd/RPM-GPG-KEY-redhat-release
  #           name: Red Hat OpenShift 4.17
  #         fast-datapath-for-rhel-9-x86_64-rpms:
  #           baseurl: http://content.example.com/rhde/rpms/fast-datapath-for-rhel-9-x86_64-rpms
  #           enabled: true
  #           gpgcheck: true
  #           gpgkey: http://content.example.com/rhel9.4/x86_64/dvd/RPM-GPG-KEY-redhat-release
  #           name: RHEL 9 Fast Data Path

  # Should work as long as no other config needs the "write_files:" key
  microshift_repos_config:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        write_files:
          - path: /etc/yum.repos.d/rhocp-4.17-for-rhel-9-x86_64-rpms
            content: |
              [rhocp-4.17-for-rhel-9-x86_64-rpms]
              baseurl = http://content.example.com/rhde/rpms/rhocp-4.17-for-rhel-9-x86_64-rpms
              enabled = true
              gpgcheck = true
              gpgkey = http://content.example.com/rhel9.4/x86_64/dvd/RPM-GPG-KEY-redhat-release
              name = Red Hat OpenShift 4.17
          - path: /etc/yum.repos.d/fast-datapath-for-rhel-9-x86_64-rpms
            content: |
              [fast-datapath-for-rhel-9-x86_64-rpms]
              baseurl = http://content.example.com/rhde/rpms/fast-datapath-for-rhel-9-x86_64-rpms
              enabled = true
              gpgcheck = true
              gpgkey = http://content.example.com/rhel9.4/x86_64/dvd/RPM-GPG-KEY-redhat-release
              name = RHEL 9 Fast Data Path          

  # Cannot merge runcmds from two CloudConfig resources in a MultipartMime, so one of them must be a SoftwareConfig resource
  # Does user_data_format: SOFTWARE_CONFIG or user_data_format: RAW makes any real difference? No
  microshift_vg_config:
    type: OS::Heat::SoftwareConfig
    properties:
      group: ungrouped
      config: |
        #!/bin/bash
        touch /root/microshift_vg_config_runcmd
        pvcreate /dev/vdb
        vgcreate rhel /dev/vdb
  # microshift_vg_config:
  #   type: OS::Heat::CloudConfig
  #   properties:
  #     cloud_config:
  #       # Feels like cloud-init should provide an easier/cleaner way of initializing disks
  #       runcmd:
  #         - touch /root/microshift_vg_config_runcmd
  #         - pvcreate /dev/vdb
  #         - vgcreate rhel /dev/vdb
  #       # Found no good examples on google using LVM
  #       # disk_setup:
  #       #   /dev/vdb:

  # Looks like this "merge" will NOT execute "runcmd" from multiple parts.
  # Looks like cannot merge any key from two CloudConfig resources in a MultipartMime and get only the key from the last part
  serverb_config:
    type: OS::Heat::MultipartMime
    properties:
      parts:
      - config: { get_resource: rhel94_repos_config }
      - config: { get_resource: microshift_repos_config }
      - config: { get_resource: microshift_vg_config }

  # Here the config merge seem to have worked well... but I cannot really test the screen reader
  workstation_config:
    type: OS::Heat::MultipartMime
    properties:
      parts:
      - config: { get_resource: rhel94_repos_config }
      - config: { get_resource: { if: [validate_screenreader, enable_config, disable_config] }}

  classroom_network:
    properties:
      name: classroom_network
      shared: false
    type: OS::Neutron::Net
  classroom_subnet:
    properties:
      cidr: 172.25.252.0/24
      dns_nameservers:
        - 8.8.8.8
      enable_dhcp: false
      gateway_ip: null
      name: classroom_subnet
      network_id:
        get_resource: classroom_network
    type: OS::Neutron::Subnet
  student_network:
    properties:
      name: student_network
      shared: false
      value_specs: { mtu: 1500 }
    type: OS::Neutron::Net
  student_subnet:
    properties:
      cidr: 172.25.250.0/24
      dns_nameservers:
        - 8.8.8.8
      enable_dhcp: false
      gateway_ip: null
      name: student_subnet
      network_id:
        get_resource: student_network
    type: OS::Neutron::Subnet
  affinity_group:
    properties:
      name: affinity_group
      policies:
        - affinity
    type: OS::Nova::ServerGroup
  bastion-0_port:
    properties:
      fixed_ips:
        - ip_address: 172.25.250.254
          subnet:
            get_resource: student_subnet
      mac_address: "52:54:00:00:FA:FE"
      name: bastion-port-0
      network:
        get_resource: student_network
      port_security_enabled: false
    type: OS::Neutron::Port
  bastion-1_port:
    properties:
      fixed_ips:
        - ip_address: 172.25.252.1
          subnet:
            get_resource: classroom_subnet
      mac_address: "52:54:00:01:FC:01"
      name: bastion-port-1
      network:
        get_resource: classroom_network
      port_security_enabled: false
    type: OS::Neutron::Port
  bastion-2_port:
    type: OS::Neutron::Port
    properties:
      name: bastion-port-2
      network:
        get_param: builder_network_id
  bastion_server:
    depends_on: classroom_server
    properties:
      availability_zone: { get_param: az }
      block_device_mapping_v2:
        - boot_index: 0
          volume_id:
            get_resource: bastion_volume_vda
      config_drive: true
      flavor: CPU_2_Memory_2048_Disk_10
      name: bastion
      networks:
        - port:
            get_resource: bastion-0_port
        - port:
            get_resource: bastion-1_port
        - port:
            get_resource: bastion-2_port
      metadata:
        allow_reset: false
        inhibit_vnc_console: true
      scheduler_hints:
        group:
          get_resource: affinity_group
    type: OS::Nova::Server
  bastion_volume_vda:
    properties:
      image: ptlab-generic-bastion-vda-9.2
      name: bastion-vda
      size: 10
    type: OS::Cinder::Volume
  classroom-0_port:
    properties:
      fixed_ips:
        - ip_address: 172.25.252.254
          subnet:
            get_resource: classroom_subnet
      mac_address: "52:54:00:00:00:FE"
      name: classroom-port-0
      network:
        get_resource: classroom_network
      port_security_enabled: false
    type: OS::Neutron::Port
  classroom-1_port:
    properties:
      network:
        get_param: { if: [validate_ssh, public_net_id, private_net_id  ] }
      port_security_enabled: false
    type: OS::Neutron::Port
  classroom-2_port:
    type: OS::Neutron::Port
    properties:
      name: classroom-port-2
      network:
        get_param: builder_network_id
  classroom_server:
    properties:
      availability_zone: { get_param: az }
      block_device_mapping_v2:
        - boot_index: 0
          volume_id:
            get_resource: classroom_volume_vda
        - boot_index: -1
          device_type: cdrom
          disk_bus: ide
          volume_id:
            get_resource: classroom_volume_hda
        - boot_index: -1
          device_type: cdrom
          disk_bus: ide
          volume_id:
            get_resource: classroom_volume_hdb
        # - boot_index: -1
        #   device_type: cdrom
        #   disk_bus: ide
        #   volume_id:
        #     get_resource: classroom_volume_hdc
      config_drive: true
      flavor: CPU_2_Memory_2048_Disk_10
      name: classroom
      networks:
        - port:
            get_resource: classroom-0_port
        - port:
            get_resource: classroom-1_port
        - port:
            get_resource: classroom-2_port
      metadata:
        allow_reset: false
        inhibit_vnc_console: true
        pkg_env: main
      # Move this to a SoftwareConfig resource and use a MultiPart resource to add my customizations without changing the standard ones?
      user_data: |
        #cloud-config
        debug: True

        # Hack classroom to remove the additional RHEL RPMs mount point
        runcmd:
          - umount /content/rhel9.2/x86_64/rhel9-additional
          - mkdir -p /content/rhel9.4/x86_64/dvd
          - sed -i '1,$ s?rhel9.2/x86_64/rhel9-additional?rhel9.4/x86_64/dvd?' /etc/fstab
          - systemctl daemon-reload
          - mount /content/rhel9.4/x86_64/dvd

        # Hack the standard RHEL 9.2 classroom VM to provide RHEL 9.4 repos
        # Could do 'runcmd' but cloud-init provides an easier/cleaner way of mounting additional disks
        # Cannot use 'mounts' because of the additional ISO I need to remove
        # mounts:
        #   - [ sr2, /content/rhel9.4/x86_64/dvd, "iso9660", "ro,auto,_netdev", "0", "0" ]
        # mounts:
        #   - [ sr1, /content/rhel9.4/x86_64/dvd, "iso9660", "ro,auto,_netdev", "0", "0" ]

        # Don't remove SSH host keys after reboot
        ssh_deletekeys: false

        # Manage users
        users:
          - name: instructor
            gecos: Instructor User
            sudo: ALL=(ALL) NOPASSWD:ALL
            passwd: $6$PwXvuS6P$8dbbPxMcMwCJwqlahjiNrkIWbbbmadGNgHppnz/Z0H8huqztgw11U6U0DPEIu1C0gxSwTbXLAF6eJeWGP70Jf1
            lock-passwd: false
            ssh_authorized_keys:
              - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGtUW3ismHyuCW4CDdTVOOOq6aySdtYenXFWWx7HJa4VTepkG00aaLId9ocra10hc+MB0GTJMCyabDv3i8NKdi6GDH/aOLVsp/Ewy8DEzZMBlJDCt4v2i4/wU4liw6KgEFkZs+5hnqU8d4QzldyGJ5onr+AGvFOKG68CS0BBl40Z1twf1HhCyx8k6nzD2ovlkxWRFZKPAFrtPCBVvQDkOfVFZF+lwzaSztgAjbFZ4A9jqQyUYx4kOJ5DtRef36ucdUdVQale0+8lICl7/gb142SPpYfhxe88/BJScLPRjvVNeu1TxRmoHtVazqnAoRxQYAn2MoI6AG+w6QuZf8f7aL LabGradingKey
              - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDUJtHiDGrVhgrIJVP/g0IAFdFKrl6JPIwfjPb53yIrVo+CQdYzhFvaOOC6QylxnrKUWt+HA8I2IhtsvyY6j9LX7MitKzTV4qinenpcTHBWhG4s8CftMCpJnvHd+ycesuO3tSRdk2p1fTqkACVa+rUcL18+0fRjT6i0yveYOX6YpkNV65VIs9oRKH+YMzp8BOwqAL5AWaE2ju5KOA5udwkD8WtaiJIxPcqF8fKuPr1Q9kebRDm5MYzFIyNCfqg5FEfEctKAdJGMmH5a0UYt6vF+jWGJXpzvMxXzEStYUG+TUvH2l6VrRSCTuhN2+3s5Dz/SdBzqpXXrNkOrU9ZlPT0/ root@training3.gsslab.rdu2.redhat.com
              - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAx/Xk+tLGBCatkBuxzyEXVhupSgb4Lema0PAnM8dFbSxcPz4W4jO8yQgtONzHs8KOhs4J1NG9bHeAwpJa2p9iJkyrigxmQv0LOpvENdlGbA1hwsRoOhBGqwRzSmKHS4Or94FBXvzDwHfbkxDV0XhzHKod8b9tYuaIQfhbF3NUR2ItZiYJhBds+3GOAHhdbU9DOAyX8X60vppkgoJ4nb2Mugw51LM+uVh8ds24wzU3Khr6Dcmae7KX/b/PX0J0rO23ZPq1AJ3i6r13AJUc6beLjQXPzYs/ZLKiQZWaZUePnsiaIpKXpH7vuBK3zidvcK2pf6XXAB9MW7GtoFJnr6v+bQ== InstructorKey
      user_data_format: RAW
      scheduler_hints:
        group:
          get_resource: affinity_group
    type: OS::Nova::Server
  classroom_volume_hda:
    properties:
      image: rhel-9.2-x86_64-dvd
      name: classroom-hda
      size: 10
      metadata: {'export': 'False'}
    type: OS::Cinder::Volume
  # classroom_volume_hdb:
  #   properties:
  #     image: rhel-9.4-x86_64-additional-20240626
  #     ##image: rh415-9.2-x86_64-additional-20230915
  #     name: classroom-hdb
  #     size: 6
  #     metadata: {'export': 'False'}
  #   type: OS::Cinder::Volume
  # classroom_volume_hdc:
  #   properties:
  #     image: rhel-9.5-x86_64-dvd
  #     name: classroom-hdc
  #     size: 12
  #     metadata: {'export': 'False'}
  #   type: OS::Cinder::Volume 
  # classroom_volume_hdc:
  classroom_volume_hdb:
    properties:
      image: rhel-9.4-x86_64-dvd
      name: classroom-hdd
      size: 12
      metadata: {'export': 'False'}
    type: OS::Cinder::Volume 
  # Add, as hdc, the image with MicroShift RPMS, images, and installers
  classroom_volume_vda:
    properties:
      image: ptlab-generic-classroom-vda-9.2
      name: classroom-vda
      size: 10
    type: OS::Cinder::Volume
  servera-0_port:
    properties:
      fixed_ips:
        - ip_address: 172.25.250.10
          subnet:
            get_resource: student_subnet
      mac_address: "52:54:00:00:FA:0A"
      name: servera-port-0
      network:
        get_resource: student_network
      port_security_enabled: false
    type: OS::Neutron::Port
  servera-1_port:
    type: OS::Neutron::Port
    properties:
      name: servera-port-1
      network:
        get_param: builder_network_id
  servera_server:
    depends_on: workstation_server
    properties:
      availability_zone: { get_param: az }
      block_device_mapping_v2:
        - boot_index: 0
          volume_id:
            get_resource: servera_volume_vda
      config_drive: true
      flavor: CPU_4_Memory_4096_Disk_10
      name: servera
      networks:
        - port:
            get_resource: servera-0_port
        - port:
            get_resource: servera-1_port
      metadata:
        allow_reset: false
        inhibit_vnc_console: false
      user_data: { get_resource: rhel94_repos_config }
      user_data_format: RAW
      scheduler_hints:
        group:
          get_resource: affinity_group
    type: OS::Nova::Server
  servera_volume_vda:
    properties:
      image: ptlab-generic-servera-vda-9.4
      name: servera-vda
      size: 50
    type: OS::Cinder::Volume
  serverb-0_port:
    properties:
      fixed_ips:
        - ip_address: 172.25.250.11
          subnet:
            get_resource: student_subnet
      mac_address: "52:54:00:00:FA:0B"
      name: serverb-port-0
      network:
        get_resource: student_network
      port_security_enabled: false
    type: OS::Neutron::Port
  serverb-1_port:
    type: OS::Neutron::Port
    properties:
      name: serverb-port-1
      network:
        get_param: builder_network_id
  serverb_server:
    depends_on: workstation_server
    properties:
      availability_zone: { get_param: az }
      block_device_mapping_v2:
        - boot_index: 0
          volume_id:
            get_resource: serverb_volume_vda
        - boot_index: -1
          volume_id:
            get_resource: serverb_volume_vdb
      config_drive: true
      flavor: CPU_2_Memory_4096_Disk_10
      name: serverb
      networks:
        - port:
            get_resource: serverb-0_port
        - port:
            get_resource: serverb-1_port
      metadata:
        allow_reset: false
        inhibit_vnc_console: false
      user_data: { get_resource: serverb_config }
      #user_data_format: SOFTWARE_CONFIG
      user_data_format: RAW
      scheduler_hints:
        group:
          get_resource: affinity_group
    type: OS::Nova::Server
  serverb_volume_vda:
    properties:
      image: ptlab-generic-serverb-vda-9.2
      name: serverb-vda
      size: 10
    type: OS::Cinder::Volume
  serverb_volume_vdb:
    properties:
      name: serverb-vdb
      size: 10
    type: OS::Cinder::Volume
  utility-0_port:
    properties:
      fixed_ips:
        - ip_address: 172.25.250.220
          subnet:
            get_resource: student_subnet
      mac_address: "52:54:00:00:FA:DC"
      name: utility-port-0
      network:
        get_resource: student_network
      port_security_enabled: false
    type: OS::Neutron::Port
  utility-1_port:
    type: OS::Neutron::Port
    properties:
      name: utility-port-1
      network:
        get_param: builder_network_id
  utility_server:
    depends_on: bastion_server
    properties:
      availability_zone: { get_param: az }
      block_device_mapping_v2:
        - boot_index: 0
          volume_id:
            get_resource: utility_volume_vda
      config_drive: true
      flavor: CPU_2_Memory_2048_Disk_10
      name: utility
      networks:
        - port:
            get_resource: utility-0_port
        - port:
            get_resource: utility-1_port
      metadata:
        allow_reset: false
        inhibit_vnc_console: false
      scheduler_hints:
        group:
          get_resource: affinity_group
    type: OS::Nova::Server
  utility_volume_vda:
    properties:
      image: ptlab-generic-utility-vda-9.2
      name: utility-vda
      size: 20
    type: OS::Cinder::Volume
  workstation-0_port:
    properties:
      fixed_ips:
        - ip_address: 172.25.250.9
          subnet:
            get_resource: student_subnet
      mac_address: "52:54:00:00:FA:09"
      name: workstation-port-0
      network:
        get_resource: student_network
      port_security_enabled: false
    type: OS::Neutron::Port
  workstation-1_port:
    type: OS::Neutron::Port
    properties:
      name: workstation-port-1
      network:
        get_param: builder_network_id
  workstation_server:
    depends_on: bastion_server
    properties:
      availability_zone: { get_param: az }
      block_device_mapping_v2:
        - boot_index: 0
          volume_id:
            get_resource: workstation_volume_vda
      config_drive: true
      flavor: CPU_4_Memory_16384_Disk_100
      #flavor: CPU_2_Memory_6144_Disk_20
      name: workstation
      networks:
        - port:
            get_resource: workstation-0_port
        - port:
            get_resource: workstation-1_port
      metadata:
        allow_reset: false
        inhibit_vnc_console: false
        pkg_env: stage
        classroom_webapp_token: { get_param: web_token }
      user_data: { get_resource: workstation_config }
      user_data_format: SOFTWARE_CONFIG
      scheduler_hints:
        group:
          get_resource: affinity_group
    type: OS::Nova::Server
  workstation_volume_vda:
    properties:
      image: ptlab-generic-workstation-vda-9.4
      name: workstation-vda
      size: 100
    type: OS::Cinder::Volume
